<!DOCTYPE html>
<html lang="en">
	<head>
		<title>David Guerreiro</title>
		<meta charset="UTF-8">
		<meta name="author" content="David Guerreiro">
		<meta name="description" content="Web developer who lives in London, specialized in HTML5, CSS3, JavaScript, PHP and MySQL Databases">
		<meta name="keywords" content="web, development, HTML5, CSS3, JavaScript, Responsive Desing, PHP, MySQL, Databases, SEO">
		<meta name="robots" content="all">
		<meta name="generator" content="sublime text 2">
		<meta name="language" content="eng">
		<meta name="subject" content="portfolio">
		<meta name="viewport" content="width=device-width; initial-scale=1.0; maximun-scale=1.0">
		<link rel="stylesheet" type="text/css" href="./css/reset.css"><!--reset css-->
		<link rel="stylesheet" type="text/css" href="./css/style.css"><!--Main css-->
		<link rel="shortcut icon" href="./favicon/favicon.jpg" type="image/jpg">
		<link rel="shortcut icon" href="./favicon/favicon.ico" type="image/x-icon">
		<link href='http://fonts.googleapis.com/css?family=Open+Sans|Francois+One' rel='stylesheet' type='text/css'>
		<link rel="stylesheet" href="./fontello-2e50e4cf/css/fontello.css"><!--css que permite la carga de las fuentes de iconos-->
	    <link rel="stylesheet" href="./fontello-2e50e4cf/css/animation.css"><!--[if IE 7]><link rel="stylesheet" href="css/iconos-ie7.css"><![endif]-->
	    <link rel="stylesheet" type="text/css" href="./js/styles/dafault.css">
	    <link rel="stylesheet" type="text/css" href="./js/styles/github.css">
	    <script type="text/javascript" src="./js/highlight.pack.js"></script>
	    <script type="text/javascript">
	    	hljs.initHighlightingOnLoad();	//Init highlight js to display raw code
	    </script>
	</head>
	<body>
		<header>
			<h1>David Guerreiro</h1>
			<h2>Web developer in London</h2>
		</header>
		<section>
			<nav>
				<div>
					<ul>
						<li><a href="index.html" title="Home" class="launcher"><i class="icon-right-big"></i>See my profile<i class="icon-left-big"></i></a></li>
					</ul>
				</div>
			</nav>
			<article class="block-color">
				<div class="content">
					<h2 class="article-title">How to develop an OOP MySql Database handler with PHP for beginners</h2>
					<p class="article-author">Written by <b>David Guerreiro</b></p>
					<h3><i class="icon-cog"></i>Introduction</h3>	
					<p>
						It's well known by every developer that working with databases can be sometimes quite tricky, especially when we are giving ours first steps in the world of the server side programing. Wordpress and similar CMS have their own database handler already implemented by default, giving us a powerful tool to deal with the DB. We only need to be worried about how good our MySql queries are and, above all, be sure that they are properly written.
					</p>
					<p>
						But what happens when we are working in a project from scratch with pure PHP ? Then we have to use all these 'mysql' (or 'mysqli') functions every time we want to open a new connection, execute a query or close the most recently connection opened. In general, beginners (me included just few months ago) waste a lot of time writing thousands of lines sending queries or checking errors. Would it be better to write some functions and avoid all these amount of work every time we want to work with databases? From my point of view, the answer is yes, definitely yes.
					</p>
					<p>
						In this article I'm going to show you how to create a class from the ground up which allow you to save a lot of time when you have to deal with a database in PHP. This is oriented to beginners and you don't even need to have a full knowledge about OOP because all methods and procedures are properly explained below and code examples are provided too.
					</p>
					<p>
						You must notice that with this article I just want to provide you with the basis you need to develop your own class to work with databases using OOP. If you want to use it in a real project, make sure to add all the security stuffs to this class in order to parse the data, avoid sql injections and so on.
					</p>
				</div>		
			</article>
			<article class="block-color">
				<div class="content">
					<h3><i class="icon-cog"></i>So what we need ?</h3>
					<p>First of all, let's going to define wich methods and attributes our class need. In order to have a robust database handler we will need, at least, the following attributes:
						<ul>
							<li>We need <b>three attributes which define the mysql server, user and the name of the database</b> in order to use them to make a new connection.</li>
							<li>We need <b>an attribute to retrieve the number of rows affected by the last connection</b> easily.</li>
							<li>We need <b>an attribute to save the connection status.</b></li>
							<li>And finally we need <b>an attribute to keep and retrieve the name of the database </b> that we are currently connected.</li>
						</ul>
					</p>
					<p>
						Now we are going to define the methods:
						<ul>
							<li>Our first method <b>will check the database connection status</b> so we will be able to test wheter the connection is properly done or not.</li>
							<li>The second one <b>will return the name of the database which we are connected</b> at the moment.</li>
							<li>The third method <b>will allow us to change the database which we are connected</b> now.</li>
							<li>With the fourth method we <b>will execute a query</b>. This method will not return any type of data. It will only check if the query was executed correctly</li>
							<li>Our fifth method <b>will allow us to get the results of the query</b>. This method will be used for SELECT queries mainly.</li>
							<li>The sixth method <b>will retrieve a single row</b> of the selected table.</li>
							<li>With the seventh method <b>we will get a single value,</b> for example, the value of a single field on the selected table.</li>
							<li>Finally, the last method <b> will close the connection with the database</b></li>
						</ul>
					</p>
					<p>
						With all the attributes and methods defined, we are now ready to start writting our class. Let's do it !
					</p>
				</div>
			</article>
			<article class="block-color">
				<div class="content">
					<h3><i class="icon-cog"></i>Class construct</h3>
					<p>
						First of all, we have to define the constructor. In PHP you can define it either writing a function with the same name that our class has or defining a function constructor. In this case, we have defined a function constructor that will be called every time time we instantiate an object. This function will allow us to establish a connection between out application / website and the database, so all the details we need to make that connection possible have to be defined here. 
					</p>
					<p>
						Don't forget to declare our new class using the reserved word <b>class</b> followed by the class's name with the first letter capitalized.
					</p>
				</div>
				<div class="content">
					<h3 class="code_example"><i class="icon-file-code"></i>Code example:</h3>
					<pre>
						<code class="lang-php hljs">
class Db{

	//Object constructor
	function __construct(){

		$mysql_server = 'localhost';		//Host where the database is installed
		$mysql_login = 'root';				//Username
		$mysql_pass = 'mypass';				//Mysql user's password -- Not used in this example
		$database_name = 'evcalculator';	//Name of the database that we want to connect

		$this->rows = 0;					

		$this->connection = mysqli_connect($mysql_server, $mysql_login);	//Establishing the connection
		settype($this->conenction, 'boolean');
		mysqli_select_db($this->connection, $database_name);				//Selecting the database

		$this->database_selected = $database_name;							

	}
						</code>
					</pre>
				</div>
				<div class="content">
					<p>
						In our constructor's example, we define the server, user, password and database name as four different variables and then we set a connection with the server through the <b>mysqli_connect()</b> function using that details. A different way to do this could be passing all the details as parameters when we instantiate the object. From my point of view, my method is quite better because if we want to change this details, we only have to change them here, and not in every declaration.
					</p>
					<p>
						Also we have now defined three attributes:
						<ul>
							<li><b>$this->rows</b> : Saves the number of affected rows in the last query</li>
							<li><b>$this->connection</b> : Saves the connection's status. Is equal to <b>true</b> when the connection with the database is successfully established.</li>
							<li><b>$this->database_selected</b> : Saves the name of the current database that we are working with.</li>
						</ul>
					</p>
				</div>
			</article>
			<article class="block-color">
				<div class="content">
					<h3><i class="icon-cog"></i>Check the connection, get the database name and change the current database</h3>
					<p>
						Now we are going to define three really simple easy-to-underestand methods. The first method will return the connection status. The second one will allow us to know the database we are working with and the third one will change the current database.
					</p>
				</div>
				<div class="content">
					<h3 class="code_example"><i class="icon-file-code"></i>Code example:</h3>
					<p>
						<b>Checking the connection: </b>
					</p>
					<pre>
						<code class="lang-php hljs">

	/**
	*
	**This method returns the connection status
	*
	*@return boolean status Connection status
	*
	*/
	public function check_connection(){

		$status = (mysqli_connect_error()) ? false : true;

		return $status;

	}

						</code>
					</pre>
					<p>
						<b>Getting the current database: </b>
					</p>
					<pre>
						<code class="lang-php hljs">

	/**
	*
	*This method returns the selected database name
	*
	*@return string $this->database_selected name of the current database in use
	*
	*/
	public function get_database(){

		return $this->database_selected;

	}

						</code>
					</pre>
					<p>
						<b>Changing the current database: </b>
					</p>
					<pre>
						<code class="lang-php hljs">

	/**
	*
	*This method change the current database
	*
	*@param string $database_name Name of the new database
	*@return boolean $this->database_selected Status of the new database change
	*
	*/
	public function change_database($database_name){

		$status = false;

		if(!is_string($database_name))
			return $status;

		if(mysqli_select_db($this->connection, $database_name)){
			$this->database_selected = $database_name;
			$status = true;
		}
									
		return $status;
	}

						</code>
					</pre>
					<p>
						The first two methods are quite simple and I think that they are explained by themselves. The third one gets the name of the new database by parameter and tries to change the current database using the<b> mysqli_select_db()</b> function. If the database if successfully changed, the attribute <b>$this->database_selected</b> is updated with the name of the new database.
					</p>
				</div>
			</article>
			<article class="block-color">
				<div class="content">
					<h3><i class="icon-cog"></i>Execute a query</h3>
					<p>
						Now let's start with more serious stuff. We are going to define a method to execute a query in out database. This method will not return any result or data, only executes a query if the query is correct, obiously.
					</p>
				</div>
				<div class="content">
					<h3 class="code_example"><i class="icon-file-code"></i>Code example:</h3>
					<pre>
						<code class="lang-php hljs">

	/**
	*
	*This method execute a query in our current database
	*
	*@param string $query Query to execute
	*@return boolean $status Status of the executed query
	*
	*/
	public function query($query){

		$status = false;

		if(!is_string($query))
			return $status;

		$status = (mysqli_query($this->connection, $query)) ? true : false;
		$rows = ($status) ? mysqli_affected_rows($this->connection) : false;
		$this->rows = (!$rows) ? $rows : $this->rows;

		return $status;

	}

						</code>
					</pre>
					<p>
						We send the query as a parameter and the the query is executed by the <b>mysql_query()</b> function. Then we check the number of rows affected by the query only if It was correct. If so, we updated our <b>$this->rows</b> value with the number of the rows affected by the query. This method returns <b>true</b> if the query is properly executed or <b>false</b> if , for whatever resason, the query failed to execute.
					</p>
				</div>
			</article>
			<article class="block-color">
				<div class="content">
					<h3><i class="icon-cog"></i>Getting some data</h3>
					<p>
						Our database class handler would not be useful if we cannot get data from the database. So It means that we need to create a method wich allow us to retrieve the data in order to display it or do whatever we want with that. In this case, the data will be returned as a numeric array, but you can modify this method to return the data as an object if you prefer.
					</p>
				</div>
				<div class="content">
					<h3 class="code_example"><i class="icon-file-code"></i>Code example:</h3>
					<pre>
						<code class="lang-php hljs">

	/**
	*
	*This method returs either an array containg every row returned by the query or boolean 
	*false if the query was wrong
	*
	*@param string $query A query to execute in out current database
	*@return array $status || boolean $status An array containgin all rows or a boolean false
	*
	*/
	public function get_results($query){

		$status = false;

		if(!is_string($query))
			return $status;

		//If this is a select query, then it should start with 'select' + the query

		$control = explode(" ", $query);

		if($control[0] != 'select')
			return $status;

		$ex = mysqli_query($this->connection, $query);

		if($ex){

										
			while($a = mysqli_fetch_assoc($ex)){

				$status[] = $a;

			}
										
			if(!is_array($status))
				return false;

			$this->rows = mysqli_affected_rows($this->connection);

			return $status;

		}

		return $status;
	}
						</code>
					</pre>
				</div>
			</article>
			<article class="block-color">
				<div class="content">
					<h3><i class="icon-cog"></i>Getting a single row</h3>
					<p>
						The next method that we are going to develop will allow us to grab a single row. The data will be returned as an associative array containing every selected column. You can see the code below:
					</p>
				</div>
				<div class="content">
					<h3 class="code_example"><i class="icon-file-code"></i>Code example:</h3>
					<pre>
						<code class="lang-php hljs">

	/**
	*
	*This method returns a single row of the requested table
	*
	*@param string $query A query to be executed in our currente database
	*@return array $status ||  boolean $status An array containing all rows or a boolean false *if an error occur
	*
	*/
	public function get_row($query){

		$status = false;

		if(!is_string($query))
			return $status;

		//If this is a select query, then it should start with 'select' + the query

		$control = explode(" ", $query);

		if($control[0] != 'select')
			return $status;

		if(!strpos($query, ' LIMIT'))
			$query .= ' LIMIT 1';
		else{
			$limit = strstr($query, 'LIMIT');
			$query = str_replace($limit, ' LIMIT 1', $query);
		}


		$ex = mysqli_query($this->connection, $query);

		if($ex){

			$status = mysqli_fetch_assoc($ex);

			if(!is_array($status))
				return false;

			$this->rows = mysqli_affected_rows($this->connection);

		}

		return $status;

	}
						</code>
					</pre>
				</div>
				<div class="content">
					As you can see on the code example above, the query is limited to one result. Both this method, the next method explained below and the get_results method <b>will return false if the query is not a select query</b>. 
				</div>
			</article>
			<article class="block-color">
				<div class="content">
					<h3><i class="icon-cog"></i>Getting a single value</h3>
					<p>
						If we have a query which should return a single value (for example, a select count query or something similar) then we should have a method to get that value quickly. Maybe you are thinking that this method could be needless because we can do exactly the same using the methods describe before. The truth is that It would be a waste of time and means to get unnecessary data if we only need one single value. Even if the other methods allow us to get exactly the same data, this method should be better in terms of performance because we are only returned the single value that we are looking for.
					</p>
				</div>
				<div class="content">
					<h3 class="code_example"><i class="icon-file-code"></i>Code example:</h3>
					<pre>
						<code class="lang-php hljs">

	/**
	*
	*This method returns a unique value of the requested table
	*
	*@param string $query A query to be executed in our current database
	*@param int $row The row wich has to be retrieved. This parameter is optional. Default : 0
	*@return unknow  $status The value of the data requested or false if there is a error
	*
	*/
	public function get_var($query, $row = 0){

		$status = false;

		if(!is_string($query))
			return $status;

		//If this is a select query, then it should start with 'select' + the query

		$control = explode(" ", $query);

		if($control[0] != 'select')
			return $status;

		//check if it is a count query

		$check = strpos($query, 'count');

		if($check !== false){
									
			//count query

			$ex = mysqli_query($this->connection, $query);

			if($ex){

				$status = mysqli_fetch_row($ex);

					if(!is_array($status))
						return false;

					$this->row = mysqli_affected_rows($this->connection);

					return $status;
			}

			return $status;
		}
		else{

		//other different query

		if(!strpos($query, ' LIMIT'))
			$query .= ' LIMIT 1';
		else{
			$limit = strstr($query, 'LIMIT');
			$query = str_replace($limit, ' LIMIT 1', $query);
		}

		$ex = mysqli_query($this->connection, $query);

		if($ex){

			$control = mysqli_fetch_array($ex);

			if(!is_array($control))
				return $status;

			$status = (array_key_exists($row, $control)) ? $control[$row] : false;
			$this->row = mysqli_affected_rows($this->connection);

			return $status;
		}

		return $status;

		}
	}

						</code>
					</pre>
				</div>
				<div class="content">
					<p>
						From my point of view, this method could be much improved. It should be tested with different type of queries in order to assess wheter the method fails or not, I mean, complex queries with <b>GROUP BY</b>, <b>JOIN</b> and <b>AS</b> statements could fail in some cases.
					</p>
				</div>
			</article>
			<article class="block-color">
				<div class="content">
					<h3><i class="icon-cog"></i>Closing the connection</h3>
					<p>
						Finally, our last method will allow us to close the connection between the database and our web site. We must call this method <b>only if we don't need to send / retrieve data for the database</b>. Our instantiated object will not work any longer and a new object has to be declared in order to open the connection again.
					</p>
				</div>
				<div class="content">
					<h3 class="code_example"><i class="icon-file-code"></i>Code example:</h3>
					<pre>
						<code class="lang-php hljs">

	/**
	*
	*This function close the mysql connection permanently
	*
	*@return boolean status True if the connection is susccessfully closed
	*
	**/
	public function close_connection(){

	$status = (mysqli_close($this->connection)) ? true : false;

	return $status;

	}

}



						</code>
					</pre>
				</div>
			</article>
			<article class="block-color">
				<div class="content">
					<h3><i class="icon-cog"></i>Conclusion</h3>
					<p>
						As you can see, we have developed an simple easy-to-use database handler which allow you to save a lot of time writing vast lines of code plagued with irksome mysql functions. Whit this class we keep all the mysql functions in the same file, so every test should be now faster than every structured programing approach.
					</p>
					<p>
						However, this class should be used carefully because, as I said at the beginning of this article, the security is not really good and someone with a basic knowledge of hacking could break our database with ease.
					</p>
			</article>
			<article class="block-color">
				<div class="content">
					<h3 class="code_example"><i class="icon-file-code"></i>Full Example:</h3>
					<pre>
						<code class="lang-php hljs">

//Database connection class - Created by David Guerreiro - me@davidguerreiro.com - davidguerreiro.com

//This class allows you to use a database object as a handler. It is quite similar to wp global $wpdb


class Db{

	//Object constructor
	function __construct(){

		$mysql_server = 'localhost';		//Host where the database is installed
		$mysql_login = 'root';				//Username
		$mysql_pass = 'mypass';				//Mysql user's password -- Not used in this example
		$database_name = 'evcalculator';	//Name of the database that we want to connect

		$this->rows = 0;					

		$this->connection = mysqli_connect($mysql_server, $mysql_login);	//Establishing the connection
		settype($this->conenction, 'boolean');
		mysqli_select_db($this->connection, $database_name);				//Selecting the database

		$this->database_selected = $database_name;							

	}

	/**
	*
	**This method returns the connection status
	*
	*@return boolean status Connection status
	*
	*/
	public function check_connection(){

		$status = (mysqli_connect_error()) ? false : true;

		return $status;

	}

	/**
	*
	*This method returns the selected database name
	*
	*@return string $this->database_selected name of the current database in use
	*
	*/
	public function get_database(){

		return $this->database_selected;
	}

	/**
	*
	*This method change the current database
	*
	*@param string $database_name Name of the new database
	*@return boolean $this->database_selected Status of the new database change
	*
	*/
	public function change_database($database_name){

		$status = false;

		if(!is_string($database_name))
			return $status;

		if(mysqli_select_db($this->connection, $database_name)){
			$this->database_selected = $database_name;
			$status = true;
		}
		
		return $status;
	}

	/**
	*
	*This method execute a query in our current database
	*
	*@param string $query Query to execute
	*@return boolean $status Status of the executed query
	*
	*/
	public function query($query){

		$status = false;

		if(!is_string($query))
			return $status;

		$status = (mysqli_query($this->connection, $query)) ? true : false;
		$rows = ($status) ? mysqli_affected_rows($this->connection) : false;
		$this->rows = (!$rows) ? $rows : $this->rows;

		return $status;
	}

	/**
	*
	*This method returs either an array containg every row returned by the query or boolean false if the query was wrong
	*
	*@param string $query A query to execute in out current database
	*@return array $status || boolean $status An array containgin all rows or a boolean false
	*
	*/
	public function get_results($query){

		$status = false;

		if(!is_string($query))
			return $status;

		//If this is a select query, then it should start with 'select' + the query

		$control = explode(" ", $query);

		if($control[0] != 'select')
			return $status;

		$ex = mysqli_query($this->connection, $query);

		if($ex){

			
			while($a = mysqli_fetch_assoc($ex)){

				$status[] = $a;

			}
			
			if(!is_array($status))
				return false;

			$this->rows = mysqli_affected_rows($this->connection);

			return $status;

		}

		return $status;
	}

	/**
	*
	*This method returns a single row of the requested table
	*
	*@param string $query A query to be executed in our currente database
	*@return array $status ||  boolean $status An array containing all rows or a boolean false if an error occur
	*
	*/
	public function get_row($query){

		$status = false;

		if(!is_string($query))
			return $status;

		//If this is a select query, then it should start with 'select' + the query

		$control = explode(" ", $query);

		if($control[0] != 'select')
			return $status;

		if(!strpos($query, ' LIMIT'))
			$query .= ' LIMIT 1';
		else{
			$limit = strstr($query, 'LIMIT');
			$query = str_replace($limit, ' LIMIT 1', $query);
		}


		$ex = mysqli_query($this->connection, $query);

		if($ex){

			$status = mysqli_fetch_assoc($ex);

			if(!is_array($status))
				return false;

			$this->rows = mysqli_affected_rows($this->connection);

		}

		return $status;

	}

	/**
	*
	*This method returns a unique value of the requested table
	*
	*@param string $query A query to be executed in our current database
	*@param int $row The row wich has to be retrieved. This parameter is optional. Default : 0
	*@return unknow  $status The value of the data requested or false if there is a error
	*
	*/
	public function get_var($query, $row = 0){

		$status = false;

		if(!is_string($query))
			return $status;

		//If this is a select query, then it should start with 'select' + the query

		$control = explode(" ", $query);

		if($control[0] != 'select')
			return $status;

		//check if it is a count query

		$check = strpos($query, 'count');

		if($check !== false){
			
			//count query

			$ex = mysqli_query($this->connection, $query);

			if($ex){

				$status = mysqli_fetch_row($ex);

				if(!is_array($status))
					return false;

				$this->row = mysqli_affected_rows($this->connection);

				return $status;
			}

			return $status;
		}
		else{

			//other different query

			if(!strpos($query, ' LIMIT'))
				$query .= ' LIMIT 1';
			else{
				$limit = strstr($query, 'LIMIT');
				$query = str_replace($limit, ' LIMIT 1', $query);
			}

			$ex = mysqli_query($this->connection, $query);

			if($ex){

				$control = mysqli_fetch_array($ex);

				if(!is_array($control))
					return $status;

				$status = (array_key_exists($row, $control)) ? $control[$row] : false;
				$this->row = mysqli_affected_rows($this->connection);

				return $status;
			}

			return $status;
		}
	}

	/**
	*
	*This function close the mysql connection permanently
	*
	*@return boolean status True if the connection is susccessfully closed
	*
	**/
	public function close_connection(){

		$status = (mysqli_close($this->connection)) ? true : false;

		return $status;
	}

	
}

						</code>
					</pre>
					<p>
						Download an example <a href="database.php" title="Download a file" download="database.php">here</a>
					</p>
				</div>
			</article>
			<article class="block-color">
				<div class="content">
					<p>
						Thank you very much for reading this article. It would be a pleasure to know you opinion so don't hesitate to <a href="https://twitter.com/Guerrebasket" title="Twitter" target="_blank">fire me a tweet</a> or <a href="mailto:me@davidguerreiro.com" title="Developer mail">send me an e-mail</a> sharing your thoughts.
					</p>
				</div>
			</article>
			<nav>
				<div>
					<ul>
						<li><a href="work.html" title="Work Experience" class="launcher"><i class="icon-right-big"></i>See my work<i class="icon-left-big"></i></a></li>
					</ul>
				</div>
			</nav>
		</section>
		<footer>
			<div class="content">
				<p>  &copy; 2015 David Guerreiro</p>
			</div>
		</footer>
	</body>
</html>
